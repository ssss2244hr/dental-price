import time
import requests
import random
from urllib.parse import urlparse

from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager

# ==============================================================================
# [ì„¤ì •] Supabase ì ‘ì† ì •ë³´ë§Œ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤!
# ==============================================================================
SUPABASE_URL = "https://kkdwgmpexkuwqyzkgvrh.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZHdnbXBleGt1d3F5emtndnJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NjA2NjgsImV4cCI6MjA4NDQzNjY2OH0.f1AOisSfwWEdrW3XdfurGT0-PT4wqrcoAVpsjzgzD1I"

headers = {
    "apikey": SUPABASE_KEY,
    "Authorization": f"Bearer {SUPABASE_KEY}",
    "Content-Type": "application/json"
}

def get_vendors_from_db():
    """DBì—ì„œ ì‡¼í•‘ëª° ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°"""
    print("ğŸ“‹ ì‡¼í•‘ëª° ì„¤ì •(Vendors)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤...")
    try:
        url = f"{SUPABASE_URL}/rest/v1/vendors?select=*"
        res = requests.get(url, headers=headers)
        res.raise_for_status()
        return res.json()
    except Exception as e:
        print(f"âŒ ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return []

def get_tasks_from_db():
    """DBì—ì„œ í¬ë¡¤ë§í•  ìƒí’ˆ URL ê°€ì ¸ì˜¤ê¸°"""
    try:
        url = f"{SUPABASE_URL}/rest/v1/vendor_products?select=*&is_active=eq.true"
        res = requests.get(url, headers=headers)
        return res.json()
    except:
        return []

def save_price(vp_id, price):
    try:
        data = {"vendor_product_id": vp_id, "price": price}
        requests.post(f"{SUPABASE_URL}/rest/v1/prices", headers=headers, json=data)
        print(f"   ğŸ’¾ ì €ì¥: {price:,}ì›")
    except:
        pass

def clean_price(text):
    try:
        return int(text.replace(",", "").replace("ì›", "").strip())
    except:
        return 0

def run_crawler():
    # 1. DBì—ì„œ ëª¨ë“  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    vendors = get_vendors_from_db() # ì‡¼í•‘ëª° ì •ë³´ (ì•„ì´ë””/ë¹„ë²ˆ í¬í•¨)
    tasks = get_tasks_from_db()     # ìƒí’ˆ URL ëª©ë¡

    if not vendors or not tasks:
        print("ì„¤ì •ì´ë‚˜ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì›¹ì‚¬ì´íŠ¸ 'ì‡¼í•‘ëª° ê´€ë¦¬'ì—ì„œ ì„¤ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
        return

    # 2. ì‡¼í•‘ëª° ID ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘ (í¸ë¦¬í•œ ì¡°íšŒë¥¼ ìœ„í•´)
    vendor_map = {v['id']: v for v in vendors}

    # 3. ì‡¼í•‘ëª°ë³„ë¡œ í•  ì¼ ë¶„ë¥˜
    grouped_tasks = {}
    for task in tasks:
        v_id = task['vendor_id']
        if v_id not in grouped_tasks: grouped_tasks[v_id] = []
        grouped_tasks[v_id].append(task)

    # 4. ë¸Œë¼ìš°ì € ì‹œì‘
    chrome_options = Options()
    # chrome_options.add_argument("--headless") # í™”ë©´ ì—†ì´ ì‹¤í–‰í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.implicitly_wait(5)

    try:
        # 5. ì‡¼í•‘ëª°ë³„ ìˆœíšŒ
        for v_id, vendor_tasks in grouped_tasks.items():
            config = vendor_map.get(v_id)
            if not config: continue

            print(f"\nğŸ¢ [{config['name']}] ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.")

            # (1) ë¡œê·¸ì¸
            if config.get('login_url') and config.get('login_id'):
                try:
                    print(f"   ğŸ”‘ ë¡œê·¸ì¸ ì‹œë„... ({config['login_url']})")
                    driver.get(config['login_url'])
                    time.sleep(2)
                    
                    # DBì— ìˆëŠ” Selectorë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥
                    if config.get('selector_id'):
                        driver.find_element(By.CSS_SELECTOR, config['selector_id']).send_keys(config['login_id'])
                    if config.get('selector_pw'):
                        driver.find_element(By.CSS_SELECTOR, config['selector_pw']).send_keys(config['login_pw'])
                        driver.find_element(By.CSS_SELECTOR, config['selector_pw']).send_keys(Keys.RETURN)
                    
                    time.sleep(3)
                    print("   ë¡œê·¸ì¸ ì™„ë£Œ (ì¶”ì •)")
                except Exception as e:
                    print(f"   âš ï¸ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: {e}")
            else:
                print("   (ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤)")

            # (2) ìƒí’ˆ ê°€ê²© ìˆ˜ì§‘
            for task in vendor_tasks:
                print(f"   â³ [{task['product_name']}] ì´ë™")
                try:
                    driver.get(task['url'])
                    time.sleep(1.5)
                    
                    selector = config.get('selector_price')
                    if selector:
                        price_text = driver.find_element(By.CSS_SELECTOR, selector).text
                        price = clean_price(price_text)
                        print(f"      ê°€ê²©: {price:,}ì›")
                        if price > 0: save_price(task['id'], price)
                    else:
                        print("      (ê°€ê²© Selector ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤)")
                        
                except Exception as e:
                    print(f"      X ì‹¤íŒ¨: {e}")

    finally:
        driver.quit()
        print("\nğŸ¤– ì‘ì—… ì¢…ë£Œ")

if __name__ == "__main__":
    run_crawler()
